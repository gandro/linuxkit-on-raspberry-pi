version: 2.1

jobs:
  build:
    docker:
      # docker and git client (on native host)
      - image: circleci/buildpack-deps:bionic-scm
        environment:
          - DOCKER_HOST: localhost:2375
      # docker daemon (on arm64)
      - image: linuxkitrpi/dockerd-arm64
    steps:
      - checkout
      - run:
          name: Wait for dockerd-arm64 to come up
          command: dockerize -wait "http://${DOCKER_HOST}/v1.39/info" -timeout 10m
      - run:
          name: Build tools/linuxkit-cli
          shell: ./circleci/run-if-changed -d tools/linuxkit-cli
          command: |
            cd tools/linuxkit-cli
            docker build -t linuxkitrpi/linuxkit-cli .
          no_output_timeout: 30m
      - run:
          name: Log in to Docker Hub
          command: docker login -u "${DOCKER_LOGIN}" -p "${DOCKER_PASSWORD}"
      - run:
          name: Push tools/linuxkit-cli
          shell: ./circleci/run-if-changed -d tools/linuxkit-cli
          command: |
            cd tools/linuxkit-cli
            docker push linuxkitrpi/linuxkit-cli