version: 2.1

orbs:
  linuxkitrpi: linuxkitrpi/builder@0.1.0

jobs:
  build_arm64:
    executor: linuxkitrpi/builder_arm64
    steps:
      - checkout
      - linuxkitrpi/wait_for_docker
      - linuxkitrpi/restore_docker_cache:
          key: v1-build-layers-arm64
      - run:
          name: Build Packages on ARM64
          command: |
            ./build.sh -s \
              images/dockerd.yml \
              pkg/chrony \
              pkg/firmware \
              pkg/wireless-regdb \
              pkg/wpa_supplicant \
              tools/linuxkit-cli \
              tools/mkimage-rpi3-squashfs \
            | tee build.log
          no_output_timeout: 20m
      - linuxkitrpi/save_docker_cache:
          key: v1-build-layers-arm64-{{ .BuildNum }}
          build_log: build.log
      - persist_to_workspace:
          root: build
          paths:
            - "*.tar"
  build_amd64:
    executor: linuxkitrpi/builder_amd64
    steps:
      - checkout
      - setup_remote_docker:
          version: "18.09.3"
      - linuxkitrpi/restore_docker_cache:
          key: v1-build-layers-amd64
      - run:
          name: Build Packages on AMD64
          command: |
            ./build.sh -s \
              kernel \
              pkg/chrony \
              pkg/wireless-regdb \
              pkg/wpa_supplicant \
              tools/dockerd-arm64 \
              tools/linuxkit-cli \
              tools/mkimage-rpi3-squashfs \
            | tee build.log
          no_output_timeout: 20m
      - linuxkitrpi/save_docker_cache:
          key: v1-build-layers-arm64-{{ .BuildNum }}
          build_log: build.log
      - persist_to_workspace:
          root: build
          paths:
            - "*.tar"
  push:
    executor: linuxkitrpi/builder_amd64
    steps:
      - checkout
      - attach_workspace:
          at: build
      - setup_remote_docker:
          version: "18.09.3"
      - run:
          name: Restore Images from Workspace
          command: find build/ -type f -name '*.tar' -exec docker load -i '{}' \;
      - run:
          name: Log in to Docker
          command: docker login -u "$DOCKER_LOGIN" -p "$DOCKER_PASSWORD"
      - run:
          name: Push Images to Docker Hub
          command: |
            ./build.sh -p \
              kernel \
              images/dockerd.yml \
              pkg/chrony \
              pkg/firmware \
              pkg/wireless-regdb \
              pkg/wpa_supplicant \
              tools/dockerd-arm64 \
              tools/linuxkit-cli \
              tools/mkimage-rpi3-squashfs

workflows:
  version: 2
  build_and_push:
    jobs:
      - build_amd64
      - build_arm64
      - push:
          context: dockerhub-creds
          requires:
            - build_amd64
            - build_arm64
          filters:
            branches:
              only: master